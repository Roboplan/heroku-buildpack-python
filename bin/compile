#!/usr/bin/env bash

# The seed runner buildpack. this buildpack does all of the parts validation and seeding
# to prepare the coming heroku environment

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

echo "HELLLO"
[ "$BUILDPACK_XTRACE" ] && set -o xtrace
echo "HELLLO2"
# Prepend proper path for virtualenv hackery. This will be deprecated soon.
export PATH=:/usr/local/bin:$PATH

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

PYTHON_EXE="/app/.heroku/python/bin/python"
PIP_VERSION="9.0.1"
SETUPTOOLS_VERSION="32.1.0"
echo "HELLLO3"
# Common Problem Warnings
export WARNINGS_LOG=$(mktemp)

# Setup bpwatch
export PATH=$PATH:$ROOT_DIR/vendor/bpwatch
LOGPLEX_KEY="t.b90d9d29-5388-4908-9737-b4576af1d4ce"
export BPWATCH_STORE_PATH=$CACHE_DIR/bpwatch.json
BUILDPACK_VERSION=v28

echo "HELLLO4"
# Setup buildpack instrumentation.
bpwatch init $LOGPLEX_KEY
bpwatch build python $BUILDPACK_VERSION $REQUEST_ID

bpwatch start compile

# Syntax sugar.
source $BIN_DIR/utils
echo "HELLLO5"
# Import collection of warnings.
source $BIN_DIR/warnings
echo "HELLLO6"
# Set up outputs under new context
EXPORT_PATH="$BIN_DIR/../export"

# We'll need to send these statics to other scripts we `source`.
export BUILD_DIR CACHE_DIR BIN_DIR EXPORT_PATH

# Switch to the repo's context.
cd $BUILD_DIR

echo "exporting config vars files from $ENV_DIR"

if [ -d "$ENV_DIR" ]; then
  for e in $(ls $ENV_DIR); do
    export "$e=$(cat $ENV_DIR/$e)"
    :
  done
fi

export FRITZING_PARTS_DIR=$BUILD_DIR/$FRITZING_PARTS_DIR_SUFFIX
echo "fritzing parts at $FRITZING_PARTS_DIR"


# Install this buildpack dependencies
source $BIN_DIR/steps/seed-runner-install

# Run this buildpack dependencies script
bash $BUILD_DIR/seed_runner_run.txt

# Now uninstall
/app/.heroku/python/bin/pip uninstall -y -r $BUILD_DIR/seed_runner_uninstall.txt

# Delete fritzing parts from the system to reduce slug size
echo "Deleting fritzing files"
rm -rfv $FRITZING_PARTS_DIR

# Fin.
bpwatch stop compile
