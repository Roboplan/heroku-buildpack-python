#!/usr/bin/env bash

# The seed runner buildpack. this buildpack does all of the parts validation and seeding
# to prepare the coming heroku environment

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

[ "$BUILDPACK_XTRACE" ] && set -o xtrace

# Prepend proper path for virtualenv hackery. This will be deprecated soon.
export PATH=:/usr/local/bin:$PATH

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
SEED_RUNNER_DIR=$1/seed_runner
CACHE_DIR=$2
ENV_DIR=$3

# Common Problem Warnings
export WARNINGS_LOG=$(mktemp)

# Syntax sugar.
source $BIN_DIR/utils

# Import collection of warnings.
source $BIN_DIR/warnings

# We'll need to send these statics to other scripts we `source`.
export BUILD_DIR CACHE_DIR BIN_DIR EXPORT_PATH

echo "exporting config vars files from $ENV_DIR"

if [ -d "$ENV_DIR" ]; then
  for e in $(ls $ENV_DIR); do
    export "$e=$(cat $ENV_DIR/$e)"
    :
  done
fi

# Install this buildpack dependencies
source $BIN_DIR/steps/seed-runner-install

# Run this buildpack dependencies script
bash $SEED_RUNNER_DIR/run.sh

# Now uninstall
#/app/.heroku/python/bin/pip uninstall -y -r $SEED_RUNNER_DIR/uninstall.txt

echo "-----> Done"

exit 0
